---
title: 运控软件的总结
author: 齐兆龙
date: 2025-12-02
category: C++
layout: post
---

---

### 主界面
继承QMainWindow，使用QDockWidget包裹消息窗口实现可移动的窗口，使用QListWidget和QStackedWidget实现左侧列表切换右侧窗口的效果。主体界面框架就是上方是菜单、action以及工具栏，中间的central widget是QStackedWidget存储着所有用到的界面，左侧是QListWidget用于切换当前的central widget，下方是message窗口。
功能界面：
- 扫图显示，通过信号槽显示相机得到的图片以及条码
- 格口显示，通过定时器每一秒刷新物料口是否有物料，定义物料的=操作，通过比较只刷新修改过的物料口的显示
- 历史记录，通过QSqlQueryModel/QTableView显示历史，并根据数据库的接口函数设置相关的筛选器，包括时间、uuid、条码等等；
- 系统设置，显示系统配置相关，支持修改保存复原等
- 日志记录，显示系统日志、业务日志和客户接口日志界面

### moduleManager模块管理器
将moduleManager用单例的方式创建在GUI线程之外，并且有成员变量QThread，再将自身移入到该线程，并启动事件循环。moduleManager使用了观察者模式进行消息的往下转发。将所有的子模块注册到moduleManager，再将其移入到moduleManager所在线程，这样就实现了工作和界面的解耦。

### 日志系统
使用了开源日志库spdlog，创建QtSink和FileSink并且绑定起来，刷新的时候不仅刷新界面而且文件也会进行刷新。设置自动滚动到底部和上下文菜单支持复制清除高亮等功能

### QSQLITE数据库模块
根据QSqlDatabas创建数据库模块。初始化通过QSqlQuery::exec创建相关表；通过QSqlQuery的prepare和addBindValue以及exec封装增、删、改、查操作；通过使用QThreadStorage管理数据库。不同线程访问数据库的时候，创建相应线程的数据库进行访问，同时存储以便以后访问直接返回即可。

### 通信模块
使用QTcpSocket、 QTcpServer和QNetworkAccessManager开发通信模块，定时器支持断线重连和心跳检查，支持发送数据和解析数据并且通过QMetaObject::invokeMethod发送给相关模块处理，支持通过tcp/ip或者http与信号灯和客户数据库接口进行通信

### 相机模块
封装相机模块，通过调用海康的SDK获取相机的图片和二维码；相机调用流程：
- 枚举相机
- 创建相机句柄
- 将句柄绑定相机
- 设置相机触发模式
- 启动相机采图
- 创建相机读图线程，采用超时机制获取一帧图片，每秒3帧，并通过信号槽发送数据给相关线程

### 固高控制模块
通过封装固高的SDK发送指令给电机进行运动，调用流程：
- 初始化设备
- 加载config文件，也就是电机参数
- 创建线程不断读取IO信号并且显示
- 调用已有的控制函数，如果回零，点位运动和获取轴状态

### 系统配置模块
创建config配置文件模块，支持配置可视化和通过界面修改保存和复原

### 其他功能
- 支持用户登录，从而修改系统配置
- 支持中英文转换，使用了QTranslator加载翻译文件；通过Linguist进行翻译；通过QApplication的installTranslator/removeTranslator加载/卸载QTranslator

### 特点
- 多线程模式，且工作线程/模块线程和GUI线程解耦，防止GUI阻塞；通过信号槽或者QMetaObject::invokeMethod跨线程通信以及在存在多线程修改的数据前加锁并执行原子操作，保证线程安全，且传教了懒汉单例模板，使用时直接继承
- 使用了观察者模式，模块管理器可向下和子模块通信；使用了状态机来控制业务的流程
- 支持耗时操作放入后台异步执行，得到结果进行刷新
- 支持XML和CSV文件的转换
- 支持中英文转换
- 支持打包发布，使用windeployqt收集Qt库，使用dumpbin查看dll依赖并复制，使用Inno Setup Complier进行打包
- 通过工厂模式创建客户数据传输策略：包括tcp/ip、excel以及http等，可拓展
- 支持海康的工业相机和智能扫码相机

### 遇到的问题
- 一开始没有考虑耦合度，全部放入了GUI线程，后面考虑到若出现问题会导致整个界面阻塞，只能关闭软件通过查看日志文件排查问题，就进行了解耦操作，进行多线程开发
- 刷新格口数据的时候，比较频繁，考虑到用户体验和性能，对数据结构定义了=操作，并且异步计算，只有数据发送变化了通过信号槽刷新界面
- 初始化过程中，组件的初始化的顺序需要固定，日志模块必须最新初始化，否则别的模块发送日志的时候有问题
- 锁的颗粒度必须考虑，只需要在改变原始数据的地方加锁即可，而不是一整个函数全部锁住，反而降低了效率；并且最好不要在加锁的地方调用了别的接口函数，非常容易导致死锁

### 打包流程
- 收集Qt库（Qt工具）：路径\windeployqt 路径\YourApp.exe
- 使用dumpbin（Visual Studio 工具）查看 .exe 或 .dll 的依赖项，若有将相关的依赖dll复制到exe下
- 使用Inno Setup Complier运行Setup.iss文件，AI完成，自己按需修改即可